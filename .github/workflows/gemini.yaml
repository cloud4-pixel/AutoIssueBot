name: Send text to Gemini (Python)

on:
  push:

jobs:
  gemini:
    runs-on: ubuntu-latest
    environment: send_to_gemini
    
    outputs:
      gemini_result: ${{ steps.gemini.outputs.gemini_result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install dependencies
        run: pip install --upgrade google-genai

      - name: Run Gemini script
        id: gemini
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: python scripts/send_to_gemini.py .  # <-- 转 转拽 砖 (驻砖专 砖转)

      - name: Print Gemini response
        run: echo "Gemini said ${{ steps.gemini.outputs.gemini_result }}"

  create_issue:
    runs-on: ubuntu-latest
    needs: gemini
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create GitHub issues per file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULTS_FILE="${{ needs.gemini.outputs.gemini_result }}"
          echo " Reading results from $RESULTS_FILE"
          while IFS= read -r line; do
            file=$(echo "$line" | cut -d'=' -f1)
            msg=$(echo "$line" | cut -d'=' -f2-)
            if [ "$msg" != "NO" ] && [ -n "$msg" ]; then
              echo "Ь Creating issue for $file"
              gh issue create \
                --repo ${{ github.repository }} \
                --title "Gemini found error in $file" \
                --body "Gemini detected an issue in **$file**  
                **Commit:** ${{ github.sha }}  
                **Branch:** ${{ github.ref_name }}  
                **Actor:** @${{ github.actor }}  
                **Problem:** $msg"
            fi
          done < "$RESULTS_FILE"
